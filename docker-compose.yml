version: '2'

services:

# PROXY ***************************

  cellar-hub-proxy:
    image: mynginx
    build:
      context: ./Nginx
      dockerfile: Dockerfile
    links:
        - cellar.hub.core.web
        - cellar.hub.core.admin
    ports:
      - 8080:8080
      - 8081:8081

# CORE ***************************

  cellar-hub-core-web:
    image: cellar.hub.core.web
    build:
      context: ./Core/Web
      dockerfile: Dockerfile
    links:
      - fluentd
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: docker.cellar.hub.core.web
    ports:
    - "44401:44401"

  cellar-hub-core-admin:
    image: cellar.hub.core.admin
    build:
      context: ./Core/Admin
      dockerfile: Dockerfile
    links:
      - fluentd
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: docker.cellar.hub.core.admin
    ports:
    - "44402:44402"

  cellar-hub-core-api:
    image: cellar.hub.core.api
    build:
      context: ./Core/Api
      dockerfile: Dockerfile
    links:
      - fluentd
      - mongodb
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: docker.cellar.hub.core.api
    ports:
    - "44403:44403"

  cellar-hub-core-cdn:
    image: cellar.hub.core.cdn
    build:
      context: ./Core/Cdn
      dockerfile: Dockerfile
    links:
      - fluentd
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: docker.cellar.hub.core.cdn
    ports:
    - "44404:44404"
    volumes:
     - /data/cellarstone.hub/core/cdn:/app/data

  cellar-hub-core-workflow:
    image: cellar.hub.core.workflow
    build:
      context: ./Core/Workflow
      dockerfile: Dockerfile
    links:
      - mongodb
      - fluentd
      - pushgateway
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: docker.cellar.hub.core.workflow
    ports:
      - "44405:44405"

  cellar-hub-core-websockets:
    image: cellar.hub.core.websockets
    build:
      context: ./Core/Websockets
      dockerfile: Dockerfile
    links:
      - fluentd
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: docker.cellar.hub.core.websockets
    ports:
    - "44406:44406"



# CORE - Third party ***************************

# don't rename to the cellar.hub.** pattern
# some stuffs with elaticsearch require the simple name pattern

  mongodb:
    image: cellar.hub.mongodb
    build: 
      context: ./Core/Db/mongodb
      dockerfile: Dockerfile
    ports:
    - "27017:27017"
    volumes:
     - /data/cellarstone.hub/core/mongodb:/data/db 

  mqtt:
    image: cellar.hub.mqtt
    build: 
      context: ./Core/Mqtt
      dockerfile: Dockerfile
    ports:
    - "1883:1883"

  fluentd:
    image: cellar.hub.fluentd
    build: ./Core/Log/fluentd
    volumes:
      - ./Core/Log/fluentd/conf:/fluentd/etc
    links:
      - "elasticsearch"
    ports:
      - "24224:24224"
      - "24224:24224/udp"

  elasticsearch:
    image: elasticsearch
    volumes:
        - /data/cellarstone.hub/core/elasticsearch:/var/lib/elasticsearch
    expose:
      - 9200
    ports:
      - "9200:9200"

  kibana:
    image: kibana
    links:
      - "elasticsearch"
    ports:
      - "5601:5601"

  prometheus:
    image: cellar.hub.prometheus
    build:
      context: ./Core/Db/prometheus
      dockerfile: Dockerfile
    volumes:
      - /data/cellarstone.hub/core/prometheus:/data/prometheus
    ports:
      - '9090:9090'
    links:
      - pushgateway
    
  #prometheus pushgateway
  pushgateway:
    image: prom/pushgateway
    ports:
      - 9091:9091

  grafana:
    image: grafana/grafana
    links:
      - prometheus
      - elasticsearch
    volumes:
      - /data/cellarstone.hub/core/grafana:/var/lib/grafana
    ports:
      - '3000:3000'

  sysmon:
    image: titpetric/netdata
    cap_add:
      - SYS_PTRACE
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    ports:
      - '19999:19999'

# MODULES ***************************

  cellar-hub-module-office-api:
    image: cellar.hub.module.office.api
    build:
      context: ./Modules/Office/Api
      dockerfile: Dockerfile
    links:
      - fluentd
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: docker.cellar.hub.module.office.api
    ports:
    - "44513:44513"

  cellar-hub-module-office-meetingrooms:
    image: cellar.hub.module.office.meetingrooms
    build:
      context: ./Modules/Office/MeetingRooms
      dockerfile: Dockerfile
    links:
      - fluentd
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: docker.cellar.hub.module.office.meetingrooms
    ports:
    - "44511:44511"

  cellar-hub-module-office-reception:
    image: cellar.hub.module.office.reception
    build:
      context: ./Modules/Office/Reception
      dockerfile: Dockerfile
    links:
      - fluentd
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: docker.cellar.hub.module.office.reception
    ports:
    - "44512:44512"
